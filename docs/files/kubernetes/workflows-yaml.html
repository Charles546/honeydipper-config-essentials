<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>workflows.yaml</title><link rel="stylesheet" type="text/css" href="../../styles/main.css" /><script type="text/javascript" src="../../styles/main.js"></script><script type="text/javascript">NDLoader.LoadJS("Content", "../../styles/");</script></head>

<!-- Generated by Natural Docs, version 2.0.2 -->

<!-- saved from url=(0016)http://localhost -->

<body onload="NDLoader.OnLoad('Content');" class="NDPage NDContentPage">

<a name="Essentials.Workflows.recycle_deployment_and_notify"></a><a name="Topic2"></a><div class="CTopic TSection LHoneydipperConfig first">
 <div class="CTitle"><span class="Qualifier">Essentials.&#8203;Workflows.</span>&#8203;recycle_deployment_and_notify</div>
 <div class="CBody"><p>Recycle a kubernetes deployment and send notification through chat system.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">.event</td><td class="CDLDefinition"><p>assuming the working is hooked up with an opsgenie alert event</p></td></tr><tr><td class="CDLEntry">.wfdata.system</td><td class="CDLDefinition"><p>in which system the kubernetes cluster is defined</p></td></tr><tr><td class="CDLEntry">.wfdata.deployment</td><td class="CDLDefinition"><p>the name of the deployment</p></td></tr><tr><td class="CDLEntry">.notify</td><td class="CDLDefinition"><p>a list of channels to notify in chat</p></td></tr><tr><td class="CDLEntry">.chat_system</td><td class="CDLDefinition"><p>which chat system to use, defaults to slack</p></td></tr></table><div class="CHeading">Examples</div><pre>---<br />rules:<br />  - when:<br />      ...<br />    <span class="SHKeyword">do</span>:<br />      content: recycle_deployment_and_notify<br />      data:<br />        system: my_kubernetes_system<br />        deployment: run=deployment_name <span class="SHComment"># this is a label selector</span><br />        notify:<br />          - <span class="SHString">&quot;#some_public_channel&quot;</span><br />          - <span class="SHString">&quot;@some_user&quot;</span></pre></div>
</div>

<a name="Essentials.Workflows.start_kube_job"></a><a name="Topic3"></a><div class="CTopic TSection LHoneydipperConfig">
 <div class="CTitle"><span class="Qualifier">Essentials.&#8203;Workflows.</span>&#8203;start_kube_job</div>
 <div class="CBody"><p>This workflow is a wrapper for <a href="../../index.html#File:kubernetes/driver.yaml:Essentials.Drivers.kubernetes.createJob" target="_top" onmouseover="NDContentPage.OnLinkMouseOver(event,44);" onmouseout="NDContentPage.OnLinkMouseOut(event);" >createJob</a> function. It uses the input data to build a job manifest with a builtin skeleton job manifest template. The job will be composed with multiple steps with each step runs as either an `initContainter` or a `container`.&nbsp; Each step <b>type</b> determines what container image to use.&nbsp; The known types are listed below, but you can always add your own types using <b>.wfdata.scripts</b> parameter.</p><ul><li><p>bash</p></li><li><p>python</p></li><li><p>python2</p></li><li><p>python3</p></li><li><p>node</p></li><li><p>tf</p></li><li><p>helm</p></li><li><p>gcloud</p></li><li><p>git</p></li></ul><div class="CHeading">Notes</div><p>The kubernetes job will mount an empty volume at <b>/honeydipper</b> to use as working directory for all the steps. This makes it possible to process artifacts in that volume across multiple steps.</p><p>It is recommended to use <a href="../../index.html#File:kubernetes/workflows.yaml:Essentials.Workflows.run_kubernetes" target="_top" onmouseover="NDContentPage.OnLinkMouseOver(event,4);" onmouseout="NDContentPage.OnLinkMouseOut(event);" >run_kubernetes</a> workflow instead, since that workflow is a wrapper for this workflow and provides some <b>predefined steps</b> that you can take advantage of.</p><p>You can also create your own wrapper workflows so you can add your predefined steps, environment variables and/or volumes.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">.wfdata.system</td><td class="CDLDefinition"><p>which kubernetes system the to use to run this job</p></td></tr><tr><td class="CDLEntry">.wfdata.steps</td><td class="CDLDefinition"><p>what steps the job will run through, each step is a separate `container` or `initContainer`.&nbsp; If the any of step is a string, it will be replaced with the named <b>predfined_step</b></p></td></tr><tr><td class="CDLEntry">.wfdata.env</td><td class="CDLDefinition"><p>a list of environment variable, follow the kuberentes pod spec for env definition If the any of env is a string, it will be replaced with the named <b>predfined_env</b></p></td></tr><tr><td class="CDLEntry">.wfdata.volumes</td><td class="CDLDefinition"><p>a list of volume definitions describing volumes to be mounted If the any of volume is a string, it will be replaced with the named <b>predfined_volume</b></p></td></tr></table><p>Following is an example two step kubernetes job to output a &quot;hello world&quot;.</p><pre>---<br />rules:<br />  - when:<br />      ...<br />    <span class="SHKeyword">do</span>:<br />      content: start_kube_job<br />      data:<br />        system: example_kube_cluster<br />        steps:<br />          prep:<br />            type: bash<br />            command: <span class="SHString">&quot;echo hello world &gt; testfile&quot;</span><br />          exec:<br />            type: bash<br />            command: <span class="SHString">&quot;cat testfile&quot;</span></pre><div class="CHeading">Predefined Parameters</div><p>Following parameters are used to create wrapper workflows. They won't be used by the job unless they are referred to in the above parameters.</p><table class="CDefinitionList"><tr><td class="CDLEntry">.wfdata.scripts</td><td class="CDLDefinition"><p>additional <b>type</b> definition in a map</p></td></tr><tr><td class="CDLEntry">.wfdata.predefined_steps</td><td class="CDLDefinition"><p>predefined steps that can be used in <b>steps</b></p></td></tr><tr><td class="CDLEntry">.wfdata.predefined_env</td><td class="CDLDefinition"><p>predefined environment variables</p></td></tr><tr><td class="CDLEntry">.wfdata.predefined_volumes</td><td class="CDLDefinition"><p>predefined volumes</p></td></tr></table><p>Following example creats a wrapper workflow with a step of sending a opsgenie heartbeat</p><pre>---<br />workflows:<br />  kube_wrapper:<br />    content: start_kube_job<br />    data:<br />      predefined_steps:<br />        send_heartbeat:<br />          type: bash<br />          command: &gt;-<br />            wget -O- -S --header <span class="SHString">&quot;Authorization: GenieKey $GENIE_KEY&quot;</span><br />            https://api.opsgenie.com/v2/heartbeats/{{ `{{ .sysData.heartbeat }}` }}/ping<br />          env:<br />            - name: GENIE_KEY<br />              valueFrom:<br />                secretRef:<br />                  name: opsgenie-key-secret<br />                  key: GENIE_KEY</pre><div class="CHeading">Script Type</div><p>Each script type definition has following fields</p><table class="CDefinitionList"><tr><td class="CDLEntry">image</td><td class="CDLDefinition"><p>the containter image to use for this type</p></td></tr><tr><td class="CDLEntry">ext</td><td class="CDLDefinition"><p>the script file extension</p></td></tr><tr><td class="CDLEntry">run_entry</td><td class="CDLDefinition"><p>use this list as <b>entrypoint</b> if running step as script file</p></td></tr><tr><td class="CDLEntry">run_prefix</td><td class="CDLDefinition"><p>use this list as <b>argument prefixes</b> if running step as script file</p></td></tr><tr><td class="CDLEntry">command_prefix</td><td class="CDLDefinition"><p>use this list as <b>argument prefixes</b> if running as command</p></td></tr></table><p>Following example creates a wrapper workflow adding a <b>gcc</b> type.</p><pre>---<br />workflows:<br />  kube_wrapper:<br />    content: start_kube_job<br />    data:<br />      scripts:<br />        gcc:<br />          image: gcc:latest</pre><div class="CHeading">Step</div><p>Steps can be either a hashmap or a list.&nbsp; The corresponding container for each step will be named step-&lt;key of map&gt; or step-&lt;number&gt;. Each step contains following fields.</p><table class="CDefinitionList"><tr><td class="CDLEntry">type</td><td class="CDLDefinition"><p>the type of the step, see above</p></td></tr><tr><td class="CDLEntry">command</td><td class="CDLDefinition"><p>the command to be executed</p></td></tr><tr><td class="CDLEntry">script</td><td class="CDLDefinition"><p>instead of using command, store the script content as file and run the file</p></td></tr><tr><td class="CDLEntry">env</td><td class="CDLDefinition"><p>a list of environment variable, follow the kuberentes pod spec for env definition</p></td></tr><tr><td class="CDLEntry">volumes</td><td class="CDLDefinition"><p>a list of volume definitions describing volumes to be mounted</p></td></tr><tr><td class="CDLEntry">workingDir</td><td class="CDLDefinition"><p>the working directory the command or script is executed in</p></td></tr></table><div class="CHeading">Volumes</div><p>You can specify volumes to be mount at step level as well as at pod level. Each volume entry should have following fields</p><table class="CDefinitionList"><tr><td class="CDLEntry">mountPath</td><td class="CDLDefinition"><p>the mount point of the volume</p></td></tr><tr><td class="CDLEntry">subPath</td><td class="CDLDefinition"><p>the sub path to mount as file</p></td></tr><tr><td class="CDLEntry">volume</td><td class="CDLDefinition"><p>the definition of a volume same as defined in kubernetes pod spec</p></td></tr></table><div class="CHeading">Return</div><table class="CDefinitionList"><tr><td class="CDLEntry">.data.metadata</td><td class="CDLDefinition"><p>the job information</p></td></tr><tr><td class="CDLEntry">.data.status</td><td class="CDLDefinition"><p>the job status when it is created</p></td></tr></table></div>
</div>

<a name="Essentials.Workflows.run_kubernetes"></a><a name="Topic4"></a><div class="CTopic TSection LHoneydipperConfig last">
 <div class="CTitle"><span class="Qualifier">Essentials.&#8203;Workflows.</span>&#8203;run_kubernetes</div>
 <div class="CBody"><p>This workflow is a wrapper for <a href="../../index.html#File:kubernetes/workflows.yaml:Essentials.Workflows.start_kube_job" target="_top" onmouseover="NDContentPage.OnLinkMouseOver(event,3);" onmouseout="NDContentPage.OnLinkMouseOut(event);" >start_kube_job</a> workflow. It provides several most frequently used predefined steps.&nbsp; It also waits for the job to complete/terminate and return the container logs.</p><div class="CHeading">Parameters</div><p>Since is a wrapper for <a href="../../index.html#File:kubernetes/workflows.yaml:Essentials.Workflows.start_kube_job" target="_top" onmouseover="NDContentPage.OnLinkMouseOver(event,3);" onmouseout="NDContentPage.OnLinkMouseOut(event);" >start_kube_job</a>, it inherits all parameters from that workflow.</p><div class="CHeading">Predefined Steps</div><table class="CDefinitionList"><tr><td class="CDLEntry">git-clone</td><td class="CDLDefinition"><p>clone a git repo into the shared empty volume /honeydipper, requires the system to have .sysData.git_url and .sysData.git_key_secret.&nbsp; The .sysData.git_url is the url of the git repo.&nbsp; The .sysData.git_key_secret should points to a kubernetes secret existing in the kubernetes cluster</p></td></tr></table><div class="CHeading">Return</div><table class="CDefinitionList"><tr><td class="CDLEntry">.data.log</td><td class="CDLDefinition"><p>a map from pod name to a map from container name to log</p></td></tr></table><div class="CHeading">Example</div><pre>---<br />rules:<br />  - when:<br />      ...<br />    <span class="SHKeyword">do</span>:<br />      type: pipe<br />      data:<br />        timeout: <span class="SHNumber">300</span><br />        project: <span class="SHString">'{{ (splitn &quot; &quot; 2 .wfdata.params)._0 }}'</span><br />        branch: <span class="SHString">'{{ default &quot;&quot; (splitn &quot; &quot; 2 .wfdata.params)._1 }}'</span><br />      content:<br />        - content: run_kubernetes<br />          data:<br />            system: terraform<br />            steps:<br />              - git-clone<br />              - script: |<br />                  terraform init -no-color<br />                  terraform plan -no-color<br />                type: tf<br />                workingDir: /honeydipper/git/projects/{{ .wfdata.project }}<br />                env:<br />                  - name: GOOGLE_CREDENTIALS<br />                    valueFrom:<br />                      secretKeyRef:<br />                        name: tf-sa<br />                        key: tf_sa<br />        - content: notify<br />          data:<br />            <span class="SHString">&quot;*notify&quot;</span>:<br />              - reply<br />            message:<br />              text: <span class="SHString">'{{ if eq .labels.status &quot;success&quot; }}{{ values (index (values .data.log) 0) | join &quot;\n&quot; }}{{ else }}{{ .labels.reason }}{{ end }}'</span></pre></div>
</div>

</body></html>